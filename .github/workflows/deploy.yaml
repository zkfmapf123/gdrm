name: Auto Deploy with Tag

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

jobs:
  auto-tag-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24.3'

    - name: Get latest tag
      id: get-latest-tag
      run: |
        # ìµœì‹  íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $LATEST_TAG"
        
        # íƒœê·¸ì—ì„œ ë²„ì „ ë²ˆí˜¸ ì¶”ì¶œ (v1.2.3 í˜•ì‹)
        if [[ $LATEST_TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
          MAJOR=${BASH_REMATCH[1]}
          MINOR=${BASH_REMATCH[2]}
          PATCH=${BASH_REMATCH[3]}
        else
          MAJOR=0
          MINOR=0
          PATCH=0
        fi
        
        # íŒ¨ì¹˜ ë²„ì „ ì¦ê°€
        NEW_PATCH=$((PATCH + 1))
        NEW_TAG="v${MAJOR}.${MINOR}.${NEW_PATCH}"
        
        echo "New tag: $NEW_TAG"
        echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
        echo "major=$MAJOR" >> $GITHUB_OUTPUT
        echo "minor=$MINOR" >> $GITHUB_OUTPUT
        echo "patch=$NEW_PATCH" >> $GITHUB_OUTPUT

    - name: Create and push tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ìƒˆ íƒœê·¸ ìƒì„±
        git tag ${{ steps.get-latest-tag.outputs.new_tag }}
        
        # íƒœê·¸ í‘¸ì‹œ
        git push origin ${{ steps.get-latest-tag.outputs.new_tag }}

    - name: Build
      run: |
        go build -o dynamoGORM ./...

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get-latest-tag.outputs.new_tag }}
        release_name: Release ${{ steps.get-latest-tag.outputs.new_tag }}
        body: |
          ## ğŸš€ DynamoGORM ${{ steps.get-latest-tag.outputs.new_tag }}
          
          ### ì£¼ìš” ë³€ê²½ì‚¬í•­
          - ìë™ ë°°í¬ ë° íƒœê·¸ ìƒì„±
          - ë²„ì „: ${{ steps.get-latest-tag.outputs.new_tag }}
          
          ### ì„¤ì¹˜ ë°©ë²•
          ```bash
          go get github.com/zkfmapf123/dynamoGORM@${{ steps.get-latest-tag.outputs.new_tag }}
          ```
          
          ### ë³€ê²½ì‚¬í•­
          - ìë™í™”ëœ ë°°í¬ í”„ë¡œì„¸ìŠ¤
          - í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
          - ì•ˆì •ì ì¸ íƒœê·¸ ê´€ë¦¬
        draft: false
        prerelease: false

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dynamoGORM
        asset_name: dynamoGORM-${{ steps.get-latest-tag.outputs.new_tag }}-linux-amd64
        asset_content_type: application/octet-stream

    - name: Notify deployment
      run: |
        echo "âœ… ë°°í¬ ì™„ë£Œ!"
        echo "ğŸ“¦ ìƒˆ íƒœê·¸: ${{ steps.get-latest-tag.outputs.new_tag }}"
        echo "ğŸ”— ë¦´ë¦¬ì¦ˆ: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get-latest-tag.outputs.new_tag }}"
